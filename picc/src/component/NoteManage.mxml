<?xml version="1.0" encoding="utf-8"?>
<mx:TitleWindow xmlns:mx="http://www.adobe.com/2006/mxml" title="笔记管理" layout="absolute" width="654" height="388" showCloseButton="true" close="close()" creationComplete="init()" horizontalAlign="center" verticalAlign="middle" borderAlpha="1" fontWeight="normal" cornerRadius="0">
	<mx:Script>
		<![CDATA[
			import mx.events.ValidationResultEvent;
			import mx.events.CloseEvent;
			import mx.events.ListEvent;
			import mx.formatters.DateFormatter;
			import mx.collections.ArrayCollection;			
			import mx.managers.PopUpManager;
			import mx.controls.Alert;
			
			private var lso:SharedObject;			
			private var modifyFlag:Boolean;
			[Bindable]
			private var noteArray:ArrayCollection;	
			private var point:Point;
			private var app:Object=null;		
			
			public function setApp(app:Object):void
			{
				this.app=app;
			}
			private function close():void
			{
				PopUpManager.removePopUp(this);	
				if(app!=null)app.isPopup=false;			
			}
			private function init():void
			{
				this.isPopUp=false;//使窗口不可拖动
				lso=SharedObject.getLocal("picc/noteInfo","/");
				if(lso==null)
				{
					Alert.show("无法获取本地共享对象!","Error");
				}
				else
				{
					if(lso.data.noteList==null)
					{
						noteArray=new ArrayCollection();
						lso.data.noteList=noteArray;
					}
					else
					{
						noteArray=lso.data.noteList;
					}				
				}
				point==new	Point();
				point.x=(this.width-200)/2;
				point.y=(this.height-110)/2;
				point=this.localToGlobal(point);					
			}			
			private function addNote():void
			{
				if(btnAdd.label=="添加笔记")
				{
					toForm();
				}
				else
				{
					var validateResult:ValidationResultEvent=title_stringValidator.validate();
					if(validateResult.type==ValidationResultEvent.VALID)
					{
						var point:Point=new	Point();
						point.x=(this.width-200)/2;
						point.y=(this.height-110)/2;
						point=this.localToGlobal(point);	
						if(modifyFlag)
						{
							modifyFlag=false;
							noteArray.getItemAt(noteArray.getItemIndex(noteList.selectedItem)).title=txtTitle.text;
							noteArray.getItemAt(noteArray.getItemIndex(noteList.selectedItem)).content=txtContent.text;
							lso.flush();													
							var alert1:Alert=Alert.show("修改成功!","提示",Alert.NONMODAL);
							PopUpManager.centerPopUp(alert1);
							alert1.move(point.x,point.y);
							back();
						}
						else
						{
							var now:Date=new Date();
							var formatter:DateFormatter=new DateFormatter();
							formatter.formatString="YYYY-MM-DD  JJ:NN:SS";
							noteArray.addItem({title:txtTitle.text,content:txtContent.text,date:formatter.format(now)});
							lso.flush();										
							var alert2:Alert=Alert.show("是否继续添加?","保存成功",Alert.YES|Alert.NO|Alert.NONMODAL,this,alertHandler);
							PopUpManager.centerPopUp(alert2);
							alert2.move(point.x,point.y);
						}				
					}					
				}
			}
			private function toForm():void
			{
				noteForm.visible=true;
				txtTitle.text=null;
				txtContent.text=null;
				noteList.visible=false;
				lblContent.visible=false;
				txtDisplay.visible=false;
				btnAdd.label="保存";
				btnClear.label="返回";				
			}
			private function alertHandler(evt:CloseEvent):void
			{
				if(evt.detail==Alert.NO)
				{
					back();
				}
				else
				{
					txtTitle.text=null;
					txtContent.text=null;
				}				
			}
			private function clearAll():void
			{
				if(btnClear.label=="全部清空")
				{									
					var alert3:Alert=Alert.show("你确定要全部清空?","确认",Alert.YES|Alert.NO|Alert.NONMODAL,this,alertHandler1);
					PopUpManager.centerPopUp(alert3);
					alert3.move(point.x,point.y);
				}
				else
				{
					back();
				}
			}
			private function alertHandler1(evt:CloseEvent):void
			{
				if(evt.detail==Alert.YES)
				{					
					noteArray.removeAll();
					txtDisplay.text=null;
				}				
			}	
			private function back():void
			{
				noteList.visible=true;
				lblContent.visible=true;
				txtDisplay.visible=true;
				noteForm.visible=false;
				btnAdd.label="添加笔记";
				btnClear.label="全部清空";
			}		
			public function deleteItem():void
			{
				noteArray.removeItemAt(noteArray.getItemIndex(noteList.selectedItem))
			}
			public function modifyItem():void
			{
				toForm();
				txtTitle.text=noteList.selectedItem.title;
				txtContent.text=noteList.selectedItem.content;				
				modifyFlag=true;
			}	
			public function displayItem():void
			{
				txtDisplay.text=noteList.selectedItem.content;
			}	
		]]>
	</mx:Script>
	<mx:Style>
		.errorTip
		{
			font-size:12;
		}
	</mx:Style>
	<mx:DataGrid width="100%" height="228" id="noteList" dataProvider="{noteArray}" visible="true" rowCount="7" rollOverColor="#E6EEEE" selectionColor="#E6EEEE">
		<mx:columns>
			<mx:DataGridColumn headerText="标题" dataField="title" width="260"/>
			<mx:DataGridColumn headerText="日期" dataField="date" width="180"/>
			<mx:DataGridColumn headerText="操作">
				<mx:itemRenderer>
					<mx:Component>
						<mx:HBox horizontalAlign="center" horizontalGap="3">
							<mx:Script>
								<![CDATA[
									private function modifyHandler():void
									{
										parentDocument.modifyItem();
									}
									private function deleteHandler():void
									{
										parentDocument.deleteItem();
									}
									private function displayHandler():void
									{
										parentDocument.displayItem();
									}
								]]>
							</mx:Script>
							<mx:LinkButton label="查看" click="displayHandler()"/>
							<mx:LinkButton label="修改" click="modifyHandler()"/>
							<mx:LinkButton label="删除" click="deleteHandler()"/>
						</mx:HBox>	
					</mx:Component>
				</mx:itemRenderer>
			</mx:DataGridColumn>			
		</mx:columns>	
	</mx:DataGrid>
	<mx:Form width="100%" height="100%" visible="false" horizontalCenter="0" verticalCenter="0" paddingBottom="10" paddingLeft="20" paddingRight="60" paddingTop="10" id="noteForm">
		<mx:FormItem label="标题：" width="100%" required="true">
			<mx:TextInput id="txtTitle" maxChars="30" width="100%"/>
		</mx:FormItem>
		<mx:FormItem label="内容：" width="100%" height="100%">
			<mx:TextArea width="100%" height="100%" maxChars="300" id="txtContent"/>
		</mx:FormItem>
	</mx:Form>
	<mx:Label x="3" y="230" text="内容：" textAlign="center" id="lblContent"/>
	<mx:TextArea x="41" y="230" height="100%" width="100%" id="txtDisplay" editable="false" borderStyle="none"/>
	<mx:StringValidator id="title_stringValidator" source="{txtTitle}" property="text" required="true" requiredFieldError="标题不能为空"/>
	<mx:ControlBar horizontalAlign="center" verticalAlign="middle" horizontalGap="30">
		<mx:Button id="btnAdd" label="添加笔记" click="addNote()" fontWeight="normal"/>
		<mx:Button id="btnClear" label="全部清空" click="clearAll()" fontWeight="normal"/>
	</mx:ControlBar>
</mx:TitleWindow>
